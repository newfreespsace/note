对于一个 $1 \sim n$ 的排列 $p_1,p_2,p_3, \cdots, p_n$ ，我们从 每个 $i$ 向 $p_i$ 连一条边，那么将得到一张 $n$ 个点，$n$ 条边的有向图，并且该图由若干个环组成。

例如排列 $2、4、6、1、5、3$，我们将得到边 $1\rightarrow2$、$2\rightarrow4$、$3\rightarrow6$、$4\rightarrow1$ 、$5\rightarrow5$、$6\rightarrow3$ 这六条边，这些边构成了一个有 $1\rightarrow 2 \rightarrow 4 \rightarrow 1, 3\rightarrow6\rightarrow3, 5\rightarrow5$ 三个环的图。

我们的目标是通过交换排列中的两个数字，得到单调递增的排列 $1、2、 \cdots、 n$。即图最后变为了 $n$ 个自环。

现在考虑交换排列中的两个数字后，图会发生怎样的改变?

排列中交换两个数字 $x、y$ 的位置后，图中指向 $x$ 的边将会指向 $y$，指向 $y$ 的边将会指向 $x$。

我们按 $x、y$ 是否在一个环中进行讨论：

- 若 $x、y$ 不在一个环中

![image-20240115105459099](C:\Users\Lee\OneDrive\笔记\算法学习\题解\assets\image-20240115105459099.png)

交换以后

![image-20240115105924711](C:\Users\Lee\OneDrive\笔记\算法学习\题解\assets\image-20240115105924711.png)

- 若 $x、y$ 在一个环中

  ![image-20240115110052953](C:\Users\Lee\OneDrive\笔记\算法学习\题解\assets\image-20240115110052953.png)

  交换以后

  ![image-20240115110138607](C:\Users\Lee\OneDrive\笔记\算法学习\题解\assets\image-20240115110138607.png)

我们可以看到交换不同位置的两个数字所造成的不同影响，因为最终目标是得到 $n$ 个自环，所有，交换发生在环内部更优，我们可以通过归纳证明得到，一个长度为 $n$ 的自环，通过至少 $n - 1$ 次环内交换，便可以得到 $n$ 个自环。

### 证明

记 $f(n)$ 表示把一个长度为 $n$ 的环变为 $n$ 个自环所需的交换次数，我们要证明 $f(n) = n - 1$。

- $n = 1$ 时，该环已经为一自环，所需的操作次数为 $0$，满足条件。

- 假设对 $\forall k < n$，有 $f(k) = k - 1$。

  当 $k = n$ 时，我们交换环内的任意两个节点，假设分别得到一个长度为 $x$ 和 $y$ 的环，那么 $f(n) = f(x) + f(y) + 1 = x - 1 + y - 1 + 1 = x + y - 1 = n - 1$。

  问题得证。

### 操作方法数

接下来，我们处理有多少中操作方法，用 $F_n$ 表示操作方法数。

假设把一个长度为 $n$ 的环拆为长度为 $x$ 和 $y$ 的两个环，用 $T(x, y)$ 表示有多少种不同的拆分方式，现在我们给出 $T(x, y)$ 的值。

- 若 $x = y$，有 $x$ 种，即 $\displaystyle \frac n2$ 种方式。
- 若 $x \neq y$，有 $x + y$ 种，即 $n$ 种方式。

把环拆为长度为 $x$ 的环和 $y$ 的环以后，我们再对 $x$ 环操作 x-1次，y 环操作 y-1次，注意到操作x环和y环的顺序可以调整，这又可以得到不同的操作方法。

最终，问题的答案 $\displaystyle F_n = \sum_{x + y = n}T(x, y)\times F_x \times F_y \times \frac{(n - 2)!}{(x-1)!(y-1)!}$。

  

